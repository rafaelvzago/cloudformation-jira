---
- name: "Playbook for installing Jira Data Center"
  hosts: localhost
  become: yes
  become_user: ec2-user
  vars_files:
    - /home/ec2-user/master/group_vars/cf_node_var.yml
    
  tasks:
    
    - name: "Download Jira Software files"
      get_url:
        url: "{{ item }}"
        dest: /home/ec2-user/downloads/
        mode: 0755
      loop:
        - https://www.atlassian.com/software/jira/downloads/binary/atlassian-jira-software-8.13.1-x64.bin

    - name: "Install fontconfig"
      become: yes
      yum:
        name: fontconfig
        state: present

    - name: Creating Jira application-data directory
      file:
        path: '{{ atl_app_data_dir }}/jira'
        state: directory

    - name: "Jira configure dbconfig.xml"
      copy:
        force: no
        src: '{{ assets_dir }}/dbconfig.xml'
        dest: '{{ atl_app_data_dir }}/jira/dbconfig.xml'

    - name: "Changing the address to the ServiceNode database"
      replace:
        path: '{{ atl_app_data_dir }}/jira/dbconfig.xml'
        regexp: "localhost:5432"
        replace: "ServiceNode:5432"

    - name: "Jira installation"
      command: '{{ downloads_path }}/atlassian-jira-software-{{ jira_version }}-x64.bin -q -varfile {{ assets_dir }}/jira/jira_response.varfile'
      args:
        creates: '{{ atl_product_dir }}/jira/bin/start-jira.sh'

    - name: "Jira cluster setup"
      copy:
        src: '{{ assets_dir }}/jira/cluster.properties'
        dest: '{{ atl_app_data_dir }}/jira/cluster.properties'

    - name: "Changing node ID {{ ansible_hostname }}"
      replace:
        path: '{{ atl_app_data_dir }}/jira/cluster.properties'
        regexp: "CLUSTERID"
        replace: "{{ ansible_hostname }}"
    
    - name: "Configure server.xml"
      copy:
        force: yes
        src: '{{ assets_dir }}/server.xml'
        dest: '{{ atl_product_dir }}/jira/conf/server.xml'
    
    - name: "Wait until Postgresql is up and running"
      wait_for:
        host: "ServiceNode"
        port: 5432

    - name:  "Start Jira"
      command: '{{ atl_product_dir }}/jira/bin/start-jira.sh'
      args:
        creates: '{{ atl_product_dir }}/jira/work/catalina.pid'