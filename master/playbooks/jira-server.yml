---
- name: "Playbook for installing Jira"
  hosts: localhost
  vars:
    my_version: "{{ version }}-x64" 
  tasks:
    
    - name: "Download Jira Software files"
      get_url:
        url: "{{ item }}"
        dest: /home/ec2-user/downloads/
        mode: 0755
      loop:
        - https://www.atlassian.com/software/jira/downloads/binary/atlassian-jira-software-{{ my_version }}.bin
    
    - name: "Install fontconfig"
      yum:
        name: fontconfig
        state: present

    - name: Creating Jira  directory
      file:
        path: /home/ec2-user/atlassian/application-data/jira
        state: directory
    
    - name: "Jira database setup"
      copy:
        src: /home/ec2-user/master/assets/dbconfig.xml
        dest: /home/ec2-user/atlassian/application-data/jira/dbconfig.xml

    - name: "Changing the IP address to the instance database"
      command: sed -i 's/localhost:5432/ServiceNode:5432/' /home/ec2-user/atlassian/application-data/jira/dbconfig.xml

    - name: "Jira installation"
      command: /home/ec2-user/downloads/atlassian-jira-software-{{ my_version }}.bin -q -varfile /home/ec2-user/master/assets/response.varfile

    - name: Check all port numbers are accessible from the current host
      wait_for:
        host: SerivceNode
        port: "{{ item }}"
        state: started         # Port should be open
        delay: 0               # No wait before first check (sec)
        timeout: 120           # Stop checking after timeout (sec)
      ignore_errors: yes
      with_items:
        - 9000
        - 5432

    - name: "Restoring Sample Data for Jira Server"
      command: pg_restore -h ServiceNode -p 5432 -U postgres -d jira -v "/home/ec2-user/master/assets/jira_server-8-13-1_sample.backup"

    - name:  "Starting Jira"
      command: /home/ec2-user/atlassian/jira/bin/start-jira.sh


    #- name: "Reindexing Jira"
      #command: curl -u admin:admin -X POST localhost:8080/rest/api/2/reindex?typeFOREGROUND
